<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenManus - 聊天历史</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .chat-container {
            max-height: 70vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .user-message {
            background-color: #e9f5ff;
            border-radius: 18px 18px 4px 18px;
        }

        .bot-message {
            background-color: #f0f0f0;
            border-radius: 18px 18px 18px 4px;
        }

        .thinking-step {
            background-color: #f9f2ff;
            border-radius: 8px;
            font-style: italic;
            border-left: 3px solid #9333ea;
        }

        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        code {
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="container mx-auto p-4 max-w-5xl">
        <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-lg shadow-lg mb-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold">OpenManus - 聊天历史</h1>
                <div>
                    <a href="/" class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-blue-100 transition">
                        <i class="fas fa-comment mr-2"></i>返回聊天
                    </a>
                </div>
            </div>
        </header>

        <!-- 历史记录列表和聊天内容并排显示 -->
        <div class="flex flex-col md:flex-row gap-4">
            <!-- 历史记录列表 -->
            <div class="w-full md:w-1/3 bg-white p-4 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">历史会话</h2>
                <div class="overflow-y-auto max-h-[70vh]">
                    <ul id="history-list" class="space-y-2">
                        {% if conversations %}
                        {% for conv in conversations %}
                        <li>
                            <button
                                class="history-item w-full text-left p-3 rounded hover:bg-gray-100 transition border border-gray-200"
                                data-id="{{ conv.id }}">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-blue-600">
                                        {{ conv.timestamp.split("T")[0] }} {{ conv.timestamp.split("T")[1].split(".")[0]
                                        }}
                                    </span>
                                    <span class="text-xs text-gray-500">{{ loop.index }}</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-1 line-clamp-2">{{ conv.preview }}</p>
                            </button>
                        </li>
                        {% endfor %}
                        {% else %}
                        <li class="text-center text-gray-500 py-4">暂无历史会话</li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- 聊天内容显示 -->
            <div class="w-full md:w-2/3 bg-white p-4 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">会话详情</h2>
                <div id="conversation-container" class="chat-container p-2">
                    <div class="text-center text-gray-500 py-10">
                        <i class="fas fa-history text-4xl mb-2"></i>
                        <p>请从左侧选择一个会话查看详情</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 获取所有历史记录项
            const historyItems = document.querySelectorAll('.history-item');

            // 为每个历史记录项添加点击事件
            historyItems.forEach(item => {
                item.addEventListener('click', function () {
                    const historyId = this.getAttribute('data-id');
                    loadConversation(historyId);

                    // 高亮当前选中项
                    historyItems.forEach(i => i.classList.remove('bg-blue-50'));
                    this.classList.add('bg-blue-50');
                });
            });

            // 如果有历史记录，默认加载第一个
            if (historyItems.length > 0) {
                historyItems[0].click();
            }
        });

        // 加载会话详情
        async function loadConversation(historyId) {
            try {
                const response = await fetch(`/api/history/${historyId}`);
                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                displayConversation(data);
            } catch (error) {
                showError('加载会话详情失败: ' + error.message);
            }
        }

        // 显示错误消息
        function showError(message) {
            const container = document.getElementById('conversation-container');
            container.innerHTML = `
                <div class="text-center text-red-500 py-10">
                    <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        // 显示会话内容
        function displayConversation(conversation) {
            const container = document.getElementById('conversation-container');
            container.innerHTML = '';

            if (!conversation.messages || conversation.messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-10">
                        <p>此会话没有消息内容</p>
                    </div>
                `;
                return;
            }

            // 添加时间戳标题
            const timestamp = new Date(conversation.timestamp);
            const formattedDate = timestamp.toLocaleDateString('zh-CN');
            const formattedTime = timestamp.toLocaleTimeString('zh-CN');

            const timeHeader = document.createElement('div');
            timeHeader.className = 'text-center text-gray-500 text-sm mb-4';
            timeHeader.textContent = `${formattedDate} ${formattedTime}`;
            container.appendChild(timeHeader);

            // 显示所有消息
            conversation.messages.forEach(message => {
                if (message.role === 'user') {
                    // 用户消息
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'user-message p-3 mb-3 ml-12';
                    messageDiv.innerHTML = `<p class="mb-1">${formatMessage(message.content)}</p>`;
                    container.appendChild(messageDiv);
                } else if (message.role === 'assistant') {
                    // 如果有思考步骤，先显示思考过程
                    if (message.thinking && message.thinking.length > 0) {
                        const thinkingContainer = document.createElement('div');
                        thinkingContainer.className = 'mb-2 mr-12';

                        // 创建思考步骤的标题和折叠按钮
                        const thinkingHeader = document.createElement('div');
                        thinkingHeader.className = 'flex items-center text-sm text-purple-700 mb-1 cursor-pointer';
                        thinkingHeader.innerHTML = `
                            <i class="fas fa-brain mr-1"></i>
                            <span>思考过程</span>
                            <i class="fas fa-chevron-down ml-1"></i>
                        `;
                        thinkingContainer.appendChild(thinkingHeader);

                        // 创建思考步骤的内容区域（默认隐藏）
                        const thinkingContent = document.createElement('div');
                        thinkingContent.className = 'hidden';

                        message.thinking.forEach(step => {
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'thinking-step p-2 mb-1 text-sm text-gray-700';
                            stepDiv.textContent = step;
                            thinkingContent.appendChild(stepDiv);
                        });

                        thinkingContainer.appendChild(thinkingContent);
                        container.appendChild(thinkingContainer);

                        // 添加折叠/展开功能
                        thinkingHeader.addEventListener('click', function () {
                            thinkingContent.classList.toggle('hidden');
                            const icon = this.querySelector('.fas.fa-chevron-down, .fas.fa-chevron-up');
                            if (icon.classList.contains('fa-chevron-down')) {
                                icon.classList.remove('fa-chevron-down');
                                icon.classList.add('fa-chevron-up');
                            } else {
                                icon.classList.remove('fa-chevron-up');
                                icon.classList.add('fa-chevron-down');
                            }
                        });
                    }

                    // 助手消息
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'bot-message p-3 mb-3 mr-12';
                    messageDiv.innerHTML = `<p class="mb-1">${formatMessage(message.content)}</p>`;
                    container.appendChild(messageDiv);
                }
            });

            // 滚动到顶部
            container.scrollTop = 0;
        }

        // 格式化消息，支持代码块
        function formatMessage(message) {
            if (!message) return '';

            // 保护输入以防XSS攻击
            let safeMessage = message
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

            // 支持代码块格式化
            safeMessage = safeMessage.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

            // 支持换行
            safeMessage = safeMessage.replace(/\n/g, '<br>');

            return safeMessage;
        }
    </script>
</body>

</html>
